! Configuration File for keepalived

# 全局配置
global_defs {
   # 建議使用主機名，方便識別
   router_id k8s-master-01
}

# 健康檢查腳本定義
vrrp_script check_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 3 # 每 3 秒檢查一次
    weight -20 # 如果腳本失敗，權重減 20
    fall 2     # 連續失敗 2 次，視為真的失敗
    rise 2     # 連續成功 2 次，視為真的恢復
}

# VRRP 實例定義
vrrp_instance VI_1 {
    state MASTER             # 此節點初始狀態為 MASTER
    interface eth0           # 網卡名稱，請用 `ip a` 或 `ifconfig` 確認您的網卡名稱
    virtual_router_id 51     # VRRP 組 ID，同一組內的節點必須相同
    priority 102             # 優先級，數值越高，優先級越高
    advert_int 1             # VRRP 通告間隔 (秒)

    # 驗證配置，同一組內必須相同
    authentication {
        auth_type PASS
        auth_pass your_secret_password # 請更換為您的密碼
    }

    # 要管理的 VIP
    virtual_ipaddress {
        192.168.0.40/24      # VIP 地址和子網掩碼
    }

    # 追蹤健康檢查腳本
    track_script {
        check_apiserver
    }
}